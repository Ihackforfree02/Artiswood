<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Undertale Crimson - Chapter 1</title>
<style>
  body { margin:0; background:#141414; font-family: consolas; }
  canvas { display:block; margin:0 auto; background:#1e1e1e; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="560"></canvas>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const WIDTH = 800, HEIGHT = 560;
const PLAYER_SIZE = 20;
let keys = {};

// --- Key Input ---
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// --- Player ---
class Player {
    constructor(x,y){
        this.x=x; this.y=y;
        this.hp=20;
        this.form='red';
        this.size=PLAYER_SIZE;
    }
    rect(){ return {x:this.x, y:this.y, w:this.size, h:this.size}; }
    draw(){ 
        let color = {'red':'#dc1e1e','sword':'#fafe50','shield':'#50a0fa','bow':'#50fa50'}[this.form];
        ctx.fillStyle=color;
        ctx.fillRect(this.x,this.y,this.size,this.size);
    }
    switchForm(){
        const forms=['red','sword','shield','bow'];
        this.form=forms[(forms.indexOf(this.form)+1)%4];
    }
    update(dt, walls){
        let dx=0,dy=0;
        if(keys['ArrowLeft']) dx=-1;
        if(keys['ArrowRight']) dx=1;
        if(keys['ArrowUp']) dy=-1;
        if(keys['ArrowDown']) dy=1;
        if(dx && dy){ dx*=0.707; dy*=0.707; }
        let spd=(this.form==='shield'?150:220)*dt;
        let newX=this.x+dx*spd, newY=this.y+dy*spd;
        if(!walls.some(w => newX<w.x+w.w && newX+this.size>w.x && newY<w.y+w.h && newY+this.size>w.y)){
            this.x=newX; this.y=newY; 
        }
    }
}

// --- NPC ---
class NPC {
    constructor(x,y,dialogue){ this.x=x; this.y=y; this.w=32; this.h=32; this.dialogue=dialogue; this.index=0; }
    rect(){ return {x:this.x, y:this.y, w:this.w, h:this.h}; }
    draw(){ ctx.fillStyle='#fafe50'; ctx.fillRect(this.x,this.y,this.w,this.h); }
    talk(){ let msg=this.dialogue[this.index]; this.index=(this.index+1)%this.dialogue.length; return msg; }
}

// --- Bullet ---
class Bullet {
    constructor(x,y,vx,vy,color='#fff',size=8){ this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.color=color; this.size=size; }
    update(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; }
    draw(){ ctx.fillStyle=this.color; ctx.fillRect(this.x,this.y,this.size,this.size); }
    rect(){ return {x:this.x, y:this.y, w:this.size, h:this.size}; }
}

// --- Boss ---
class Boss {
    constructor(name,hp,center,patterns){
        this.name=name; this.hp=hp; this.max_hp=hp;
        this.center=center;
        this.patterns=patterns;
        this.phase=0;
        this.timer=0;
        this.attacking=false;
    }
    startAttack(){ this.attacking=true; this.timer=0; }
    update(dt, bullets, player){
        if(!this.attacking) return;
        this.timer+=dt;
        this.patterns[this.phase](this.timer, bullets, player);
        if(this.timer>4){ this.attacking=false; this.phase=(this.phase+1)%this.patterns.length; }
    }
    draw(){
        ctx.fillStyle='#32fa32';
        ctx.beginPath(); ctx.arc(this.center[0], this.center[1], 60,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#141414';
        ctx.beginPath(); ctx.arc(this.center[0]-15, this.center[1]-15, 10,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(this.center[0]+15, this.center[1]-15, 10,0,Math.PI*2); ctx.fill();
        // HP bar
        ctx.fillStyle='red'; ctx.fillRect(300,40,200,12);
        ctx.fillStyle='yellow'; ctx.fillRect(300,40,200*(this.hp/this.max_hp),12);
        ctx.fillStyle='white'; ctx.font='18px consolas'; ctx.fillText(this.name,300,20);
    }
}

// --- Boss patterns ---
function ashrootPattern(t, bullets){ if(Math.floor(t*10)%12===0){ for(let i=0;i<5;i++) bullets.push(new Bullet(160-20, 60+i*60,150,0,'#32fa32',12)); } }
function synthixPattern(t, bullets){ if(Math.floor(t*10)%10===0){ for(let i=0;i<8;i++){ let a=i*Math.PI*2/8; bullets.push(new Bullet(400,120,Math.cos(a)*180,Math.sin(a)*180,'#50faca')); } } }
function veyraPattern(t, bullets){ if(Math.floor(t*10)%15===0) bullets.push(new Bullet(Math.random()*480+160, 60,0,180,'#50a0fa')); }

// --- Battle ---
class Battle {
    constructor(boss){
        this.player=new Player(400,200);
        this.bullets=[];
        this.boss=boss;
        this.state='MENU';
        this.sel=0;
        this.msg=`${boss.name} blocks your path!`;
    }
    update(dt){
        this.player.update(dt,[]);
        this.bullets.forEach(b=>b.update(dt));
        this.bullets=this.bullets.filter(b=>b.x>-50 && b.x<850 && b.y>-50 && b.y<600);
        this.bullets.forEach(b=>{
            let r=this.player.rect();
            if(b.x<r.x+r.w && b.x+b.size>r.x && b.y<r.y+r.h && b.y+b.size>r.y){ this.player.hp--; }
        });
        if(this.state==='ENEMY'){ this.boss.update(dt,this.bullets,this.player); if(!this.boss.attacking) this.state='MENU'; }
    }
    draw(){
        ctx.fillStyle='#141414'; ctx.fillRect(0,0,WIDTH,HEIGHT);
        ctx.strokeStyle='white'; ctx.strokeRect(160,60,480,320);
        this.boss.draw();
        this.bullets.forEach(b=>b.draw());
        this.player.draw();
        const opts=['FIGHT','ACT','ITEM','MERCY'];
        opts.forEach((o,i)=>{ ctx.fillStyle=i===this.sel?'#fafe50':'white'; ctx.fillText(o,200+i*100,60+320+60); });
        ctx.fillStyle='white'; ctx.fillText(`HP: ${this.player.hp}/20`,160,60+320+20);
        ctx.fillStyle='yellow'; ctx.fillText(this.msg,200,60+320+100);
    }
    act(choice){
        if(choice==='FIGHT'){ let dmg=Math.floor(Math.random()*4)+5; this.boss.hp-=dmg; this.msg=`You hit ${this.boss.name} for ${dmg}!`; this.state='ENEMY'; this.boss.startAttack(); }
        if(choice==='ACT'){ this.msg=`You talk to ${this.boss.name}. They giggle.`; this.state='ENEMY'; this.boss.startAttack(); }
        if(choice==='ITEM'){ this.player.hp=Math.min(20,this.player.hp+5); this.msg=`You eat a snack. +5 HP.`; this.state='ENEMY'; this.boss.startAttack(); }
        if(choice==='MERCY'){ if(this.boss.hp<Math.floor(this.boss.max_hp*0.25)){ this.msg=`You spared ${this.boss.name}!`; this.state='WIN'; } else { this.msg=`${this.boss.name} refuses mercy!`; this.state='ENEMY'; this.boss.startAttack(); } }
    }
}

// --- Overworld ---
class Overworld {
    constructor(){
        this.player=new Player(400,300);
        this.npcs=[ new NPC(200,200, ["Hi!","Watch out for Ashroot!"]), new NPC(500,150, ["Welcome to the forest!","Have fun!"]) ];
        this.walls=[{x:100,y:100,w:600,h:20},{x:100,y:400,w:600,h:20}];
        this.state='PLAY';
        this.bosses=[ new Boss('Ashroot',40,[400,120],[ashrootPattern]),
                      new Boss('Synthix',50,[400,120],[synthixPattern]),
                      new Boss('Veyra',60,[400,120],[veyraPattern]) ];
        this.battle=null;
        this.msg='';
    }
    update(dt){
        if(this.state==='PLAY'){
            this.player.update(dt,this.walls);
            this.bosses.forEach((boss,i)=>{
                let trigger={x:150+i*200,y:250,w:50,h:50};
                let r=this.player.rect();
                if(r.x<trigger.x+trigger.w && r.x+r.w>trigger.x && r.y<trigger.y+trigger.h && r.y+r.h>trigger.y){
                    this.state='BATTLE'; this.battle=new Battle(boss); this.msg=`A wild ${boss.name} appears!`;
                }
            });
        } else if(this.state==='BATTLE'){
            this.battle.update(dt);
            if(this.battle.state==='WIN'){ this.state='PLAY'; this.msg=`${this.battle.boss.name} defeated!`; this.bosses.shift(); }
        }
    }
    draw(){
        ctx.fillStyle='#141414'; ctx.fillRect(0,0,WIDTH,HEIGHT);
        if(this.state==='PLAY'){
            ctx.fillStyle='white';
            this.walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));
            this.npcs.forEach(n=>n.draw());
            this.player.draw();
            if(this.msg){ ctx.fillStyle='yellow'; ctx.fillText(this.msg,200,20); }
        } else if(this.state==='BATTLE'){ this.battle.draw(); }
    }
}

const world=new Overworld();
let lastTime=0;
function gameLoop(timestamp){
    let dt=(timestamp-lastTime)/1000; lastTime=timestamp;
    if(keys['q']){ keys['q']=false; if(world.state==='PLAY') world.player.switchForm(); else world.battle.player.switchForm(); }
    if((keys['z']||keys['Enter'])){ keys['z']=keys['Enter']=false;
        if(world.state==='PLAY'){
            world.npcs.forEach(n=>{
                let r=world.player.rect(), nr=n.rect();
                if(r.x<nr.x+nr.w && r.x+r.w>nr.x && r.y<nr.y+nr.h && r.y+r.h>nr.y){ world.msg=n.talk(); }
            });
        } else if(world.state==='BATTLE' && world.battle.state==='MENU'){
            world.battle.act(['FIGHT','ACT','ITEM','MERCY'][world.battle.sel]);
        }
    }
    if(world.state==='BATTLE'){
        if(keys['ArrowRight']){ keys['ArrowRight']=false; world.battle.sel=(world.battle.sel+1)%4; }
        if(keys['ArrowLeft']){ keys['ArrowLeft']=false; world.battle.sel=(world.battle.sel+3)%4; }
    }
    world.update(dt);
    world.draw();
    requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
