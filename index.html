<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crimson Quest - Chapter 1</title>
<style>
  body{margin:0;overflow:hidden;background:#0b0b0b;font-family:monospace;}
  canvas{display:block;margin:0 auto;background:#0c0c12;border:4px solid #141414;}
  #uiOverlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
  #bubble{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:#12121a;color:#ffd166;padding:10px 14px;border:2px solid #fff;max-width:500px;display:none;}
  #hud{position:absolute;top:10px;left:10px;color:#fff;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="960" height="720"></canvas>
<div id="uiOverlay">
  <div id="bubble"></div>
  <div id="hud"></div>
</div>
<script>
"use strict";

// ----------- Canvas Setup -------------
const canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d');
const bubble=document.getElementById('bubble'), hud=document.getElementById('hud');
const WIDTH=canvas.width, HEIGHT=canvas.height;
let keys={};

// ----------- Input -------------
document.addEventListener('keydown',e=>keys[e.key]=true);
document.addEventListener('keyup',e=>keys[e.key]=false);

// ----------- Game State -------------
let STATE="OVERWORLD"; // or "BATTLE"

// ----------- Overworld Entities -------------
class Player{
  constructor(x,y){
    this.x=x; this.y=y; this.w=32; this.h=48; this.color='#dc1e1e';
    this.velX=0; this.velY=0; this.speed=250; this.jumpPower=550; this.gravity=1600;
    this.onGround=false; this.hp=50; this.maxHp=50; this.canDash=true; this.dashPower=600;
  }
  rect(){ return {x:this.x,y:this.y,w:this.w,h:this.h}; }
  update(dt,walls){
    // Horizontal
    if(keys['ArrowLeft']||keys['a']) this.velX=-this.speed;
    else if(keys['ArrowRight']||keys['d']) this.velX=this.speed;
    else this.velX=0;
    // Jump
    if((keys['ArrowUp']||keys['w']||keys[' ']) && this.onGround){ this.velY=-this.jumpPower; this.onGround=false; }
    // Dash
    if(keys['Shift'] && this.canDash){ this.velX*=3; this.velY=0; this.canDash=false; }
    if(!keys['Shift']) this.canDash=true;
    // Gravity
    this.velY+=this.gravity*dt;
    // Movement
    let newX=this.x+this.velX*dt, newY=this.y+this.velY*dt;
    this.onGround=false;
    for(let w of walls){
      // Horizontal
      if(newX<w.x+w.w && newX+this.w>w.x && this.y<w.y+w.h && this.y+this.h>w.y){
        if(this.velX>0) newX=w.x-this.w;
        if(this.velX<0) newX=w.x+w.w;
        this.velX=0;
      }
      // Vertical
      if(this.x<w.x+w.w && this.x+this.w>w.x && newY<w.y+w.h && newY+this.h>w.y){
        if(this.velY>0){ newY=w.y-this.h; this.velY=0; this.onGround=true; }
        if(this.velY<0){ newY=w.y+w.h; this.velY=0; }
      }
    }
    this.x=newX; this.y=newY;
    // Bounds
    if(this.x<0) this.x=0; if(this.x+this.w>WIDTH) this.x=WIDTH-this.w;
    if(this.y+this.h>HEIGHT){ this.y=HEIGHT-this.h; this.velY=0; this.onGround=true; }
  }
  draw(){ ctx.fillStyle=this.color; ctx.fillRect(this.x,this.y,this.w,this.h); }
}

class Wall{ constructor(x,y,w,h){ this.x=x; this.y=y; this.w=w; this.h=h; } draw(){ ctx.fillStyle='#888'; ctx.fillRect(this.x,this.y,this.w,this.h); } }
class NPC{ constructor(x,y,text){ this.x=x; this.y=y; this.text=text; this.w=32; this.h=48; } rect(){ return {x:this.x,y:this.y,w:this.w,h:this.h}; } draw(){ ctx.fillStyle='#50fa50'; ctx.fillRect(this.x,this.y,this.w,this.h); } }
class BossTrigger{ constructor(x,y,bossFunc){ this.x=x; this.y=y; this.w=48; this.h=48; this.bossFunc=bossFunc; } rect(){ return {x:this.x,y:this.y,w:this.w,h:this.h}; } draw(){ ctx.fillStyle='#ffea80'; ctx.fillRect(this.x,this.y,this.w,this.h); } }

const player=new Player(100,400);
const walls=[ new Wall(0,650,960,70), new Wall(300,500,200,20), new Wall(600,400,200,20) ];
const npcs=[ new NPC(500,570,"Hello traveler! Use Z to talk.") ];
let bosses=[];

// ----------- Battle Entities -------------
let BOSS={name:'Storm Herald', hp:360, hpMax:360, spareReq:5};
let HEART={x:480,y:510,r:5,sp:300,i:0,hp:50,hpMax:50};
let bullets=[], zones=[], telegraphs=[], attack=null;
let turn='player', showArena=false, damagePopup=null;

// ----------- HUD Functions -------------
function updateHUD(){
  if(STATE==="OVERWORLD") hud.innerHTML=`HP: ${player.hp}/${player.maxHp}`;
  else if(STATE==="BATTLE") hud.innerHTML=`Player HP: ${HEART.hp}/${HEART.hpMax} | Boss: ${BOSS.hp}/${BOSS.hpMax}`;
}
function showBubbleText(t){ bubble.innerText=t; bubble.style.display='block'; }
function hideBubbleText(){ bubble.style.display='none'; }

// ----------- Helper Collision -------------
function rectsOverlap(a,b){ return a.x<a.x+a.w && b.x<b.x+b.w && a.y<a.y+a.h && b.y<b.y+b.h && a.x+b.w>a.x && a.y+b.h>a.y; }
function intersect(a,b){ return !(a.x+b.w<a.x || a.x>a.x+b.w || a.y+b.h<a.y || a.y>a.y+b.h); }

// ----------- Game Loop -------------
let lastTime=0;
function gameLoop(timestamp){
  let dt=(timestamp-lastTime)/1000; lastTime=timestamp;
  update(dt); draw();
  requestAnimationFrame(gameLoop);
}

// ----------- Update Function -------------
function update(dt){
  if(STATE==="OVERWORLD"){
    player.update(dt,walls);
    // NPC interactions
    for(let n of npcs){
      let r=player.rect(), nr=n.rect();
      if(r.x<nr.x+nr.w && r.x+r.w>nr.x && r.y<nr.y+nr.h && r.y+r.h>nr.y){
        if(keys['z'] || keys['Z']) showBubbleText(n.text);
      }
    }
    // Boss triggers
    for(let b of bosses){
      let r=player.rect(), br=b.rect();
      if(r.x<br.x+br.w && r.x+r.w>br.x && r.y<br.y+br.h && r.y+r.h>br.y){
        STATE="BATTLE"; startBattle(b.bossFunc);
      }
    }
  }
  else if(STATE==="BATTLE"){
    // Battle logic will be re-used from template
    HEART.i=Math.max(0,HEART.i-dt);
    // Bullet updates
    for(const b of bullets){
      b.t+=dt;
      if(b.type==='shock') b.r+=b.vr*dt;
      if(b.type==='bolt'){ if(b.t>=0) b.y+=b.vy*dt; }
    }
    bullets=bullets.filter(b=>b.type!=='shock' || b.r<300);
  }
  updateHUD();
}

// ----------- Draw Function -------------
function draw(){
  ctx.fillStyle='#0c0c12'; ctx.fillRect(0,0,WIDTH,HEIGHT);
  if(STATE==="OVERWORLD"){
    walls.forEach(w=>w.draw());
    npcs.forEach(n=>n.draw());
    bosses.forEach(b=>b.draw());
    player.draw();
  } else if(STATE==="BATTLE"){
    // Draw battle arena, boss sprite, bullets
    ctx.fillStyle='#222'; ctx.fillRect(240,420,480,180);
    ctx.fillStyle='red'; ctx.fillRect(240,420+180,480*BOSS.hp/BOSS.hpMax,10);
    // Draw bullets
    bullets.forEach(b=>{
      if(b.type==='shock'){ ctx.strokeStyle='yellow'; ctx.beginPath(); ctx.arc(480,510,b.r,0,Math.PI*2); ctx.stroke(); }
      if(b.type==='bolt'){ ctx.fillStyle='white'; ctx.fillRect(b.x,b.y,b.w,b.h); }
    });
    // Draw HEART
    ctx.fillStyle='lime'; ctx.beginPath(); ctx.arc(HEART.x,HEART.y,HEART.r,0,Math.PI*2); ctx.fill();
  }
}

// ----------- Start Battle -------------
function startBattle(bossFunc){
  showArena=true;
  turn='player';
  BOSS.hp=BOSS.hpMax;
  HEART.hp=HEART.hpMax;
  attack=bossFunc;
}

// ----------- Initialize ---------
bosses.push(new BossTrigger(800,580,()=>{
  console.log("Battle triggered: Storm Herald!");
}));
updateHUD();
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
